<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dual.Infodose — Monólito</title>

<!-- Lucide icons CDN -->
<script src="https://cdn.jsdelivr.net/npm/lucide/dist/lucide.min.js"></script>
<!-- html2canvas for PNG export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#020406;
    --muted:#9aa6b3;
    --text:#e6eef6;
    --panel: rgba(255,255,255,0.05);
    --panel-border: rgba(255,255,255,0.10);
    --accent-default: #4fd4ff;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    --radius-lg: 20px;
    --radius-md: 12px;
    --glass: rgba(255,255,255,0.03);
    --glass-strong: rgba(0,0,0,0.6);
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box;overflow:hidden;position:relative;user-select:text;}
  .glow{position:fixed;inset:0;pointer-events:none;opacity:.28;z-index:0;border-radius:0;transition:background .35s ease}
  .container{width:100%;max-width:1180px;display:grid;grid-template-columns:1fr;gap:18px;z-index:10}
  @media(min-width:1024px){ .container{grid-template-columns:1fr 420px;} }

  /* Generic button system */
  .btn {
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid transparent;
    background:var(--glass);
    color:var(--text);
    font-weight:700;
    font-size:13px;
    cursor:pointer;
    transition:transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
    text-decoration:none;
    user-select:none;
  }
  .btn:active{ transform:translateY(1px) scale(.998); }
  .btn:focus{ outline:2px solid rgba(255,255,255,0.06); outline-offset:3px; }
  .btn.primary{ background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(240,240,240,0.95)); color:#000; border-color:rgba(0,0,0,0.06); }
  .btn.ghost{ background:rgba(255,255,255,0.03); border-color:rgba(255,255,255,0.06); }
  .btn.ghost:hover{ background:rgba(255,255,255,0.06); }
  .btn.warn{ background:linear-gradient(180deg,#ffd3d3,#ffcfcf); color:#000; }
  .btn.small{ padding:8px 10px; font-size:12px; font-weight:800; border-radius:10px }
  .icon-btn{ width:40px; height:40px; padding:0; justify-content:center; border-radius:10px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04) }
  .icon-btn.active{ background:var(--accent-default); color:#000; box-shadow:0 8px 30px -10px currentColor; border-color:transparent; }
  .icon-btn:focus{ box-shadow:0 0 0 4px rgba(0,0,0,0.2); }

  /* Left monolith */
  .monolith{display:none;flex-direction:column;gap:16px;background:rgba(255,255,255,0.02);border:1px solid var(--panel-border);border-radius:var(--radius-lg);padding:20px;height:720px;backdrop-filter:blur(10px);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  @media(min-width:1024px){ .monolith{display:flex} }

  .monolith .head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.04);padding-bottom:12px}
  .mono-title{display:flex;gap:10px;align-items:center}
  .mono-title h2{font-size:13px;margin:0;letter-spacing:.06em}
  .status-pill{font-family:var(--mono);font-size:11px;background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  label.small{font-size:11px;font-weight:800;opacity:.6;display:block;margin-bottom:6px}
  input,select{width:100%;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:12px;color:var(--text);outline:none;font-size:13px}
  select{appearance:none;padding-right:28px}

  .control-row{display:flex;gap:8px;align-items:center}
  .control-col{display:flex;flex-direction:column;gap:8px}

  .log-area{flex:1;background:rgba(0,0,0,0.28);border:1px solid rgba(255,255,255,0.04);border-radius:16px;padding:14px;overflow:auto;font-family:var(--mono);font-size:12px}
  .log-item{display:flex;gap:10px;margin-bottom:8px}
  .log-item .time{opacity:.35;min-width:70px}
  .log-item .msg{color:var(--muted);white-space:pre-wrap}
  .log-item.exec .msg{color:#3dd5ff}

  .monolith .buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .hint{font-size:12px;color:var(--muted);font-family:var(--mono);padding-top:6px}

  /* Voice panel inside monolith */
  .voice-panel{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:8px}
  .voice-row{display:flex;gap:8px;align-items:center}

  /* Right card */
  .card-wrap{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--glass-strong);border:1px solid rgba(255,255,255,0.06);border-radius:32px;overflow:hidden;backdrop-filter:blur(12px);transition:all .5s;box-shadow:0 30px 90px -30px rgba(0,0,0,0.8)}
  .card.collapsed{height:80px}
  .card-header{display:flex;align-items:center;justify-content:space-between;padding:18px;cursor:pointer}
  .brand h1{margin:0;font-weight:300;font-size:18px}
  .brand b{font-weight:800}
  .pill{font-family:var(--mono);font-size:10px;letter-spacing:.18em}

  .controls{display:flex;align-items:center;gap:8px}

  .card-body{padding:24px 28px 28px;opacity:1;transition:opacity .4s}
  .card-body.hidden{opacity:0;height:0;padding:0 28px}

  .profile{display:flex;flex-direction:column;align-items:center;gap:10px}
  .avatar-wrap{position:relative}
  .avatar{width:96px;height:96px;border-radius:50%;border:2px dashed var(--accent-default);display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.45))}
  .lvl{position:absolute;right:-8px;bottom:-8px;background:rgba(0,0,0,0.65);border:1px solid rgba(255,255,255,0.06);padding:4px 8px;border-radius:8px;font-family:var(--mono);font-size:11px}

  .controls-block{padding:10px 0;display:flex;flex-direction:column;gap:10px}
  .label-row{display:flex;justify-content:space-between;align-items:flex-end}
  .input-line{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.02);padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,0.04)}
  .input-line input[type="text"]{background:transparent;border:none;outline:none;color:#fff;font-weight:700;font-size:14px;width:100%}

  .progress-segs{display:flex;gap:6px;height:8px}
  .seg{flex:1;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
  .seg .fill{height:100%;width:0%;transition:width 1s ease}

  .revealed{transition:max-height .7s,opacity .7s;overflow:hidden}
  .revealed.hidden{max-height:0;opacity:0}
  .revealed.show{max-height:500px;opacity:1}

  .reveal-box{background:rgba(0,0,0,0.6);padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.04);font-family:var(--mono);font-size:12px;line-height:1.4}
  .action-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
  .btn.small{padding:10px;font-size:11px;border-radius:12px}

  .mobile-only{display:block}
  @media(min-width:1024px){ .mobile-only{display:none} }

  .credit{text-align:center;font-family:var(--mono);font-size:10px;opacity:.18;letter-spacing:.25em}

  /* Toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(10px);bottom:24px;background:var(--accent-default);color:#000;padding:10px 18px;border-radius:999px;font-weight:900;font-family:var(--mono);font-size:11px;opacity:0;pointer-events:none;transition:all .45s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}

  /* accessibility helpers */
  [role="status"]{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
<div class="app">
  <div id="bgGlow" class="glow"></div>

  <div class="container">

    <!-- LEFT: Monolith -->
    <aside class="monolith" id="monolithPanel" aria-labelledby="monoTitle">
      <div class="head">
        <div class="mono-title" id="monoTitle">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 17v-6" stroke-width="1.4"/><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="1.4"/></svg>
          <h2>Painel Monólito KOBLLUX</h2>
        </div>
        <div class="status-pill" id="monoStatus" aria-live="polite">STATUS: IDLE</div>
      </div>

      <div class="grid-2">
        <div class="control-col">
          <label class="small">OpenRouter Key</label>
          <input id="skInput" type="password" placeholder="sk-...">
        </div>
        <div class="control-col">
          <label class="small">Modelo Ativo</label>
          <select id="modelSelect" aria-label="Modelo Ativo">
            <option value="deepseek/deepseek-chat">DeepSeek V3</option>
            <option value="meta-llama/llama-3-70b">LLaMA 3 70B</option>
            <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
          </select>
        </div>
      </div>

      <!-- Voice controls -->
      <div class="voice-panel" aria-label="Painel de Voz">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">TTS / Voz</div>
          <div style="font-size:12px;color:var(--muted);font-family:var(--mono)"><span id="voicesCount">0</span> voices</div>
        </div>

        <div class="voice-row" style="gap:10px">
          <select id="voiceSelect" style="flex:1"></select>
          <button id="voiceTestBtn" class="btn small ghost" title="Testar voz">Testar</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label class="small">Pitch <span id="pitchVal" style="font-family:var(--mono);font-size:12px;color:var(--muted)">0.90</span></label>
            <input id="pitchInput" type="range" min="0.5" max="2.0" step="0.05" value="0.9">
          </div>
          <div style="flex:1">
            <label class="small">Rate <span id="rateVal" style="font-family:var(--mono);font-size:12px;color:var(--muted)">1.10</span></label>
            <input id="rateInput" type="range" min="0.5" max="2.0" step="0.05" value="1.1">
          </div>
        </div>
      </div>

      <div class="log-area" id="logs" aria-live="polite">
        <!-- logs go here -->
      </div>

      <div class="buttons" style="margin-top:6px">
        <button class="btn primary" id="saveBtn" title="Salvar Config"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor"/></svg> Salvar Config</button>
        <button class="btn ghost" id="clearLogsBtn" title="Limpar Logs"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="currentColor"/><path d="M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="currentColor"/></svg> Limpar Logs</button>
      </div>

      <div class="hint">Dica: pressione Enter no campo principal para testar TTS ou copiar ID quando o painel for revelado.</div>
    </aside>

    <!-- RIGHT: Card -->
    <main class="card-wrap" aria-live="polite">
      <div id="card" class="card collapsed" role="region" aria-label="Dual Infodose Card">
        <div class="card-header" id="cardHeader" title="Clique para abrir/fechar">
          <div>
            <div class="brand"><h1>Dual.<b id="brandAccent" style="color:var(--accent-default)">Infodose</b></h1>
            <p class="pill" id="identityText">Interface Locked</p></div>
          </div>

          <div class="controls">
            <button id="micBtn" class="icon-btn" aria-pressed="false" title="Ativar/Desativar voz"><i data-lucide="mic"></i></button>
            <button id="chevBtn" class="icon-btn chev" title="Abrir/Fechar"><i data-lucide="chevrondown"></i></button>
          </div>
        </div>

        <div id="cardBody" class="card-body hidden">
          <div class="profile">
            <div class="avatar-wrap">
              <div id="avatar" class="avatar">??</div>
              <div class="lvl">LVL_5.3</div>
            </div>
          </div>

          <div class="controls-block">
            <div class="label-row">
              <span style="font-size:11px;font-weight:800;opacity:.45;letter-spacing:.06em">Neural Codename</span>
              <span id="syncText" style="font-family:var(--mono);font-weight:800;font-size:11px">0% SYNC</span>
            </div>

            <div class="input-line">
              <input id="userInput" type="text" placeholder="Quem é você?" aria-label="Quem é você?">
            </div>

            <div class="progress-segs" id="progressSegs" aria-hidden="true">
              <div class="seg"><div class="fill" data-step="0"></div></div>
              <div class="seg"><div class="fill" data-step="20"></div></div>
              <div class="seg"><div class="fill" data-step="40"></div></div>
              <div class="seg"><div class="fill" data-step="60"></div></div>
              <div class="seg"><div class="fill" data-step="80"></div></div>
            </div>
          </div>

          <div id="revealedSection" class="revealed hidden" aria-hidden="true">
            <div class="reveal-box">
              <div style="position:absolute;right:10px;top:6px;opacity:.18"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2v20" stroke="currentColor"/></svg></div>
              <p style="color:#3dd5ff;margin:0 0 8px 0">[ QUANTUM TOKEN ]</p>
              <div id="activationInfo">ID: _SONIC_5.3<br>STATUS: CONNECTION_STABLE<br>ENCRYPTION: AES_256_KOBLLUX<br><span style="color:#ff69b4">PROMPT: ATIVAR_MODO_IA</span></div>
            </div>

            <div class="action-grid">
              <button class="btn small primary" id="copyBtn" title="Copiar Ativação"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M16 4h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-2" stroke="currentColor"/></svg> Copiar Ativação</button>
              <button class="btn small ghost" id="pngBtn" title="Exportar cartão como PNG"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor"/></svg> PNG</button>
              <button class="btn small ghost" id="shareBtn" title="Compartilhar Ativação"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M4 12v7a1 1 0 0 0 1 1h14" stroke="currentColor"/></svg> Share</button>
              <button class="btn small ghost" id="copyPromptBtn" title="Copiar prompt">Copiar Prompt</button>
            </div>
          </div>

          <div class="mobile-only" style="padding-top:12px;border-top:1px solid rgba(255,255,255,0.04);margin-top:12px">
            <button class="btn ghost" id="monolithSettingsBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor"/></svg> Monolith Settings</button>
          </div>
        </div>
      </div>

      <div class="credit">KOBLLUX · Senior Dev Mode · 2025</div>
    </main>

  </div>

  <div id="fusion_toast" class="toast" role="status" aria-live="polite"></div>
</div>

<script>
/* ========== Icons init ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  if(window.lucide) lucide.createIcons();
});

/* ========== DOM refs ========== */
const logsEl = document.getElementById('logs');
const skInput = document.getElementById('skInput');
const modelSelect = document.getElementById('modelSelect');
const saveBtn = document.getElementById('saveBtn');
const clearLogsBtn = document.getElementById('clearLogsBtn');

const card = document.getElementById('card');
const cardHeader = document.getElementById('cardHeader');
const chevBtn = document.getElementById('chevBtn');
const cardBody = document.getElementById('cardBody');
const micBtn = document.getElementById('micBtn');

const userInputEl = document.getElementById('userInput');
const avatarEl = document.getElementById('avatar');
const syncText = document.getElementById('syncText');
const progressFills = document.querySelectorAll('.fill');
const identityText = document.getElementById('identityText');
const revealedSection = document.getElementById('revealedSection');
const activationInfo = document.getElementById('activationInfo');
const copyBtn = document.getElementById('copyBtn');
const pngBtn = document.getElementById('pngBtn');
const shareBtn = document.getElementById('shareBtn');
const copyPromptBtn = document.getElementById('copyPromptBtn');
const monolithSettingsBtn = document.getElementById('monolithSettingsBtn');
const monoStatus = document.getElementById('monoStatus');
const brandAccent = document.getElementById('brandAccent');
const bgGlow = document.getElementById('bgGlow');
const toast = document.getElementById('fusion_toast');

const voiceSelect = document.getElementById('voiceSelect');
const voiceTestBtn = document.getElementById('voiceTestBtn');
const voicesCount = document.getElementById('voicesCount');
const pitchInput = document.getElementById('pitchInput');
const rateInput = document.getElementById('rateInput');
const pitchVal = document.getElementById('pitchVal');
const rateVal = document.getElementById('rateVal');

/* ========== LocalStorage keys & initial state ========== */
const LS = {
  SK: 'INFODOSE_OPENROUTER_SK',
  MODEL: 'INFODOSE_OPENROUTER_MODEL',
  USER: 'fusion_user',
  VOICE_URI: 'fusion_voice_uri',
  VOICE_PITCH: 'fusion_voice_pitch',
  VOICE_RATE: 'fusion_voice_rate'
};

let logs = [{time: (new Date()).toLocaleTimeString(), msg: "SYSTEM_READY // V5.3"}];
let voiceEnabled = false;
let revealed = false;
let sync = 0;
let voices = [];
let selectedVoice = localStorage.getItem(LS.VOICE_URI) || '';
let pitch = parseFloat(localStorage.getItem(LS.VOICE_PITCH) || '0.9');
let rate = parseFloat(localStorage.getItem(LS.VOICE_RATE) || '1.1');
const synth = window.speechSynthesis || null;

/* ========== Load persisted values ========== */
skInput.value = localStorage.getItem(LS.SK) || '';
modelSelect.value = localStorage.getItem(LS.MODEL) || 'deepseek/deepseek-chat';
userInputEl.value = localStorage.getItem(LS.USER) || '';
pitchInput.value = pitch;
rateInput.value = rate;
pitchVal.textContent = pitch.toFixed(2);
rateVal.textContent = rate.toFixed(2);

/* ========== Helpers ========== */
function addLog(msg){
  const time = (new Date()).toLocaleTimeString();
  logs.unshift({time,msg});
  if(logs.length>200) logs = logs.slice(0,200);
  renderLogs();
}
function renderLogs(){
  logsEl.innerHTML = '';
  for(let i=0;i<logs.length;i++){
    const it = logs[i];
    const div = document.createElement('div');
    div.className = 'log-item' + (it.msg.includes('EXEC') ? ' exec' : '');
    div.innerHTML = '<div class="time">['+it.time+']</div><div class="msg">'+escapeHtml(it.msg)+'</div>';
    logsEl.appendChild(div);
  }
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function getThemeColor(text){
  if(!text) return getComputedStyle(document.documentElement).getPropertyValue('--accent-default').trim() || '#4fd4ff';
  let h = 0;
  for(let i=0;i<text.length;i++) h = text.charCodeAt(i) + ((h<<5)-h);
  const hue = Math.abs(h%360);
  return `hsl(${hue}, 70%, 55%)`;
}
function applyAccent(text){
  const accent = getThemeColor(text);
  brandAccent.style.color = accent;
  avatarEl.style.borderColor = accent;
  avatarEl.style.color = accent;
  bgGlow.style.background = `radial-gradient(circle at 50% 50%, ${accent}11 0%, transparent 70%)`;
  // update icon active state color dynamic shadow
  document.querySelectorAll('.icon-btn.active').forEach(b => { b.style.boxShadow = `0 18px 80px -30px ${accent}`; });
}
function updateSyncFromInput(text){
  const s = Math.min(Math.round((text.length/12)*100),100);
  sync = s;
  syncText.textContent = `${s}% SYNC`;
  progressFills.forEach(el=>{
    const step = parseInt(el.getAttribute('data-step'));
    if(s>step) el.style.width='100%'; else el.style.width='0%';
    el.style.background = getThemeColor(text);
  });
}
function computeRevealed(){
  if(sync >= 30 && !revealed){
    revealed = true;
    addLog("IDENTITY_CONFIRMED: Access Granted");
    revealedSection.classList.remove('hidden');
    revealedSection.classList.add('show');
    monoStatus.textContent = 'STATUS: STABLE';
    identityText.textContent = 'Identity Confirmed';
    revealedSection.setAttribute('aria-hidden','false');
  } else if (sync < 30 && revealed){
    revealed = false;
    addLog("IDENTITY_LOST: Interface Locked");
    revealedSection.classList.add('hidden');
    revealedSection.classList.remove('show');
    monoStatus.textContent = 'STATUS: IDLE';
    identityText.textContent = 'Interface Locked';
    revealedSection.setAttribute('aria-hidden','true');
  }
}
function updateAvatar(text){
  const s = (text||'').trim();
  avatarEl.textContent = s ? s.substring(0,2).toUpperCase() : '??';
}
let toastTimer = null;
function showToast(text='Ação Concluída', ms=2200){
  toast.textContent = text;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toast.classList.remove('show'); }, ms);
}

/* ========== TTS functions ========== */
function loadVoices(){
  if(!synth) return;
  voices = synth.getVoices() || [];
  // sort prioritizing pt-BR
  voices.sort((a,b)=>{
    const aPt = a.lang && a.lang.includes('pt-BR');
    const bPt = b.lang && b.lang.includes('pt-BR');
    if(aPt === bPt) return (a.name||'').localeCompare(b.name||'');
    return aPt ? -1 : 1;
  });
  voiceSelect.innerHTML = '';
  voices.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.voiceURI || (v.name + '|' + v.lang);
    opt.textContent = `${v.name} · ${v.lang || ''}`;
    voiceSelect.appendChild(opt);
  });
  voicesCount.textContent = voices.length;
  // try to restore selectedVoice
  if(selectedVoice){
    const found = Array.from(voiceSelect.options).find(o => o.value === selectedVoice);
    if(found) voiceSelect.value = selectedVoice;
  } else {
    // pick a pt-BR if exists
    const pt = voices.find(v=>v.lang && v.lang.includes('pt-BR'));
    if(pt) { selectedVoice = pt.voiceURI; voiceSelect.value = selectedVoice; }
  }
  addLog('VOICES_LOADED: ' + voices.length + ' voices');
}
function speak(text){
  if(!voiceEnabled || !synth) return;
  try{
    synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    let voice = voices.find(v=>v.voiceURI===selectedVoice) || voices.find(v=>v.lang && v.lang.includes('pt-BR')) || voices[0];
    if(voice) utter.voice = voice;
    utter.pitch = pitch;
    utter.rate = rate;
    utter.onstart = ()=>{ micBtn.classList.add('active'); micBtn.setAttribute('aria-pressed','true'); }
    utter.onend = ()=>{ micBtn.classList.remove('active'); micBtn.setAttribute('aria-pressed','false'); }
    synth.speak(utter);
    addLog(`TTS_EXEC: "${(text||'').substring(0,40)}..."`);
  }catch(err){
    addLog('TTS_ERROR: ' + (err.message || err));
  }
}
function toggleVoice(){
  voiceEnabled = !voiceEnabled;
  if(voiceEnabled){
    speak("Voz ativa.");
    addLog("VOICE_ONLINE");
    micBtn.classList.add('active');
    micBtn.setAttribute('aria-pressed','true');
  } else {
    if(synth) synth.cancel();
    micBtn.classList.remove('active');
    micBtn.setAttribute('aria-pressed','false');
    addLog("VOICE_OFFLINE");
  }
}

/* ========== UI updates based on user input ========== */
function updateAllFromUser(text){
  applyAccent(text);
  updateAvatar(text);
  updateSyncFromInput(text);
  computeRevealed();
  activationInfo.innerHTML = 'ID: ' + ((text||'').toUpperCase().replace(/\s/g,'_') || '_SONIC_5.3') + '<br>STATUS: CONNECTION_STABLE<br>ENCRYPTION: AES_256_KOBLLUX<br><span style="color:#ff69b4">PROMPT: ATIVAR_MODO_IA</span>';
}

/* ========== Actions ========== */
function saveConfig(){
  localStorage.setItem(LS.SK, skInput.value);
  localStorage.setItem(LS.MODEL, modelSelect.value);
  localStorage.setItem(LS.USER, userInputEl.value);
  localStorage.setItem(LS.VOICE_URI, selectedVoice);
  localStorage.setItem(LS.VOICE_PITCH, String(pitch));
  localStorage.setItem(LS.VOICE_RATE, String(rate));
  addLog("CONFIG_SAVED: LocalStorage updated");
  showToast('Config salva');
}
function clearLogs(){
  logs = [{time:(new Date()).toLocaleTimeString(),msg:"LOGS_CLEARED"}];
  renderLogs();
  addLog('LOGS_CLEARED_BY_USER');
  showToast('Logs limpos');
}
function copyActivation(){
  const id = (userInputEl.value || '').toUpperCase().replace(/\s/g,'_') + '_SONIC_5.3';
  navigator.clipboard?.writeText(id).then(()=>{ showToast('ID copiado'); addLog('ACTIVATION_COPIED'); }, ()=>{ showToast('Falha ao copiar'); addLog('ACTIVATION_COPY_FAIL'); });
}
function copyPrompt(){
  const prompt = 'ATIVAR_MODO_IA';
  navigator.clipboard?.writeText(prompt).then(()=>{ showToast('Prompt copiado'); addLog('PROMPT_COPIED'); }, ()=>{ showToast('Falha ao copiar prompt'); addLog('PROMPT_COPY_FAIL'); });
}
async function pngAction(){
  try{
    addLog('PNG_REQUESTED');
    // temporarily expand card if collapsed to ensure full render
    const wasCollapsed = card.classList.contains('collapsed');
    if(wasCollapsed){ toggleCard(); await new Promise(r=>setTimeout(r,220)); }
    const node = document.getElementById('card');
    const canvas = await html2canvas(node, {backgroundColor: null, scale: 2});
    canvas.toBlob(function(blob){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = ((userInputEl.value||'infodose').replace(/\s/g,'_') || 'infodose') + '.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('PNG gerado');
      addLog('PNG_SAVED');
    }, 'image/png');
    if(wasCollapsed){ toggleCard(); }
  }catch(err){ addLog('PNG_ERROR: '+(err.message||err)); showToast('Erro PNG'); }
}
function shareAction(){
  const id = (userInputEl.value || '').toUpperCase().replace(/\s/g,'_') + '_SONIC_5.3';
  const text = `Dual Infodose — ID: ${id}\nKOBLLUX · Senior Dev Mode`;
  if(navigator.share){
    navigator.share({ title: 'Dual Infodose', text }).then(()=>{ addLog('SHARED_VIA_WEBAPI'); showToast('Compartilhado'); }).catch(e=>{ addLog('SHARE_FAIL: '+(e.message||e)); showToast('Falha ao compartilhar'); });
  } else {
    navigator.clipboard?.writeText(text).then(()=>{ showToast('Texto copiado (fallback)'); addLog('SHARE_FALLBACK_COPY'); }, ()=>{ showToast('Share falhou'); addLog('SHARE_FALLBACK_FAIL'); });
  }
}
function mobileMonolithSettings(){ addLog("MOBILE_CONFIG_REQUESTED"); showToast('Monolith settings'); }

/* toggle card open */
let isCardOpen = false;
function toggleCard(){
  isCardOpen = !isCardOpen;
  if(isCardOpen){
    card.classList.remove('collapsed');
    cardBody.classList.remove('hidden');
    chevBtn.classList.add('rot');
  } else {
    card.classList.add('collapsed');
    cardBody.classList.add('hidden');
    chevBtn.classList.remove('rot');
  }
}

/* ========== Event listeners ========== */
cardHeader.addEventListener('click', (e)=>{
  // ignore clicks on controls
  if(e.target.closest('.icon-btn')) return;
  toggleCard();
});
chevBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleCard(); });
micBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleVoice(); });
saveBtn.addEventListener('click', saveConfig);
clearLogsBtn.addEventListener('click', clearLogs);

userInputEl.addEventListener('input', (e)=>{
  const v = e.target.value;
  localStorage.setItem(LS.USER, v);
  updateAllFromUser(v);
});
userInputEl.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    if(revealed){
      copyActivation();
    } else {
      speak(userInputEl.value || 'Olá');
    }
  }
});

copyBtn.addEventListener('click', copyActivation);
pngBtn.addEventListener('click', pngAction);
shareBtn.addEventListener('click', shareAction);
copyPromptBtn.addEventListener('click', copyPrompt);
monolithSettingsBtn.addEventListener('click', mobileMonolithSettings);

/* Voice UI events */
voiceSelect.addEventListener('change', (e)=>{ selectedVoice = e.target.value; localStorage.setItem(LS.VOICE_URI, selectedVoice); addLog('VOICE_SELECTED: ' + selectedVoice); });
voiceTestBtn.addEventListener('click', ()=>{ const sample = userInputEl.value || 'Olá, teste de voz.'; speak(sample); });
pitchInput.addEventListener('input', (e)=>{ pitch = parseFloat(e.target.value); pitchVal.textContent = pitch.toFixed(2); localStorage.setItem(LS.VOICE_PITCH, String(pitch)); });
rateInput.addEventListener('input', (e)=>{ rate = parseFloat(e.target.value); rateVal.textContent = rate.toFixed(2); localStorage.setItem(LS.VOICE_RATE, String(rate)); });

/* protect header icon clicks from toggling card */
document.querySelectorAll('.icon-btn').forEach(btn => btn.addEventListener('click', (ev)=>ev.stopPropagation()));

/* ========== Speech voices init handling ========== */
if(synth){
  const load = ()=>{
    loadVoices();
    voicesCount.textContent = (synth.getVoices()||[]).length;
  };
  load();
  if('onvoiceschanged' in synth) synth.onvoiceschanged = load;
}

/* initialize logs & UI */
renderLogs();
applyAccent(userInputEl.value || '');
updateSyncFromInput(userInputEl.value || '');
computeRevealed();

/* expose for debugging */
window.__infodose = { addLog, saveConfig, speak, toggleVoice, updateAllFromUser, pngAction };

</script>
</body>
</html>