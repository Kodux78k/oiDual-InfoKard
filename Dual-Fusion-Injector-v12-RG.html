<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL // FUSION â€” OS Kernel v11.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#030406">

  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;800&family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#030406">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .catch(err => console.error('SW Error:', err));
    }
  </script>

  <style>
    :root {
      /* Palette Unificada */
      --bg-deep: #030406;
      --glass-surface: rgba(20, 20, 25, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --neon-cyan: #00f2ff;
      --neon-purple: #bd00ff;
      --neon-green: #23ac51;
      --neon-orange: #f97316;
      --neon-blue: #3b82f6;
      
      /* Animation */
      --ease-elastic: cubic-bezier(0.34, 1.3, 0.64, 1);
      --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 20px;
      min-height: 100vh;
      background-color: var(--bg-deep);
      color: #fff;
      font-family: 'Montserrat', sans-serif;
      overflow-x: hidden;
      background-image: radial-gradient(circle at 50% 0%, rgba(20,20,30,1) 0%, rgba(3,4,6,1) 100%);
    }

    /* Ambient Blobs */
    .blob { position: fixed; border-radius: 50%; filter: blur(90px); opacity: 0.15; z-index: -1; animation: float 20s infinite alternate; }
    .b1 { width: 300px; height: 300px; background: var(--neon-cyan); top: -50px; left: -50px; }
    .b2 { width: 350px; height: 350px; background: var(--neon-purple); bottom: -50px; right: -50px; animation-delay: -5s; }
    @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px,50px); } }

    /* LAYOUT GRID */
    .layout {
      width: 100%; max-width: 1200px; margin: 0 auto;
      display: grid; grid-template-columns: 380px 1fr; gap: 30px;
      align-items: start;
    }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

    /* --- COMPONENTE 1: CONTROL MODULE (Esquerda) --- */
    .fusion-card {
      position: relative;
      background: var(--glass-surface);
      backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      padding: 24px;
      transition: all 0.5s var(--ease-elastic);
      display: flex; flex-direction: column; gap: 15px;
    }
    
    .fusion-card.open { border-color: var(--neon-purple); box-shadow: 0 0 30px rgba(189, 0, 255, 0.1); }

    .card-header { display: flex; align-items: center; gap: 15px; cursor: pointer; user-select: none; }
    .avatar-ring { 
      width: 50px; height: 50px; border-radius: 50%; 
      background: conic-gradient(from 0deg, var(--neon-cyan), var(--neon-purple), var(--neon-cyan));
      padding: 2px; flex-shrink: 0;
    }
    .avatar-inner { width: 100%; height: 100%; background: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    .header-info { display: flex; flex-direction: column; flex: 1; }
    .brand { font-size: 1.4rem; font-weight: 800; letter-spacing: -1px; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .status { font-size: 0.65rem; color: var(--neon-cyan); letter-spacing: 2px; text-transform: uppercase; font-family: 'JetBrains Mono'; }

    /* Blocos Recursivos (Filhos do Fusion) */
    .recursive-block { 
      background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 15px; 
      opacity: 0; transform: translateY(10px); transition: all 0.3s var(--ease-smooth); display:none; 
    }
    .fusion-card.open .recursive-block { display: flex; flex-direction: column; gap: 10px; }
    .fusion-card.open .recursive-block.show { opacity: 1; transform: translateY(0); display: flex; }

    /* Inputs & Buttons Fusion */
    .cyber-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0; color: #fff; font-family: 'JetBrains Mono'; font-size: 0.9rem; transition: 0.3s; }
    .cyber-input:focus { border-bottom-color: var(--neon-cyan); }

    .action-row { display: flex; gap: 8px; margin-top: 5px; }
    .icon-btn { 
      flex: 1; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); 
      border-radius: 10px; color: rgba(255,255,255,0.7); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; 
    }
    .icon-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
    .icon-btn.primary { background: rgba(0, 242, 255, 0.1); border-color: rgba(0, 242, 255, 0.3); color: var(--neon-cyan); }

    /* --- COMPONENTE 2: VAULT (Direita) --- */
    .master-card {
      background: var(--glass-surface); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border-radius: 20px; border: 1px solid var(--glass-border);
      margin-bottom: 12px; position: relative; overflow: hidden;
      transition: all 0.3s var(--ease-smooth);
    }
    .master-card.expanded { border-color: var(--neon-blue); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    
    .inner { padding: 16px; }
    .vault-header { display: flex; justify-content: space-between; align-items: center; }
    
    .title-group { flex-grow: 1; cursor: pointer; overflow: hidden; }
    .card-title { font-weight: 700; font-size: 1rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;}
    .card-meta { font-size: 0.65rem; color: #94a3b8; font-family: 'JetBrains Mono'; margin-top: 4px; display: flex; align-items: center; gap: 8px; }
    .tag-badge { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; color: var(--neon-cyan); font-weight: bold; }

    /* Dock de AÃ§Ãµes */
    .dock { display: flex; gap: 4px; align-items: center; }
    .ico { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); color: #cbd5e1; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    .ico:hover { background: rgba(255,255,255,0.1); color: #fff; transform: scale(1.1); }
    
    .content-box { max-height: 0; overflow: hidden; opacity: 0; transition: all 0.4s var(--ease-smooth); }
    .expanded .content-box { max-height: 1200px; opacity: 1; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }

    .code-area { 
      width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 12px; color: #e2e8f0; font-family: 'JetBrains Mono'; font-size: 0.8rem; 
      line-height: 1.5; min-height: 120px; resize: vertical; display: block;
    }

    /* Warframe (App Container) */
    .warframe-view { width: 100%; height: 350px; border: none; background: #fff; border-radius: 12px; margin-top: 10px; }

    /* Filter Bar */
    .filter-bar { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .filter-pill { 
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #888; 
      padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; 
    }
    .filter-pill.active { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); }

    /* Immersive Overlay */
    #immersiveLayer { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    #immersiveLayer.active { opacity: 1; pointer-events: all; }
    .immersive-header { height: 50px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #050505; }
    
    /* Fullscreen Buttons */
    .fs-header-btn { height:30px; padding:0 12px; border-radius:8px; background: rgba(255,255,255,0.03); color:#cbd5e1; border: 1px solid transparent; cursor:pointer; font-weight:700; font-size:0.7rem; }
    .fs-header-btn:hover { background: rgba(255,255,255,0.06); color: white; border-color: rgba(255,255,255,0.08); }
    .fs-save { border-color: rgba(35,172,81,0.3); color: var(--neon-green); background: rgba(35,172,81,0.1); }
    .fs-save:hover { background: var(--neon-green); color:#000; box-shadow:0 0 10px var(--neon-green); }

  </style>
</head>
<body>
  
  <div class="blob b1"></div>
  <div class="blob b2"></div>

  <div id="immersiveLayer">
    <div class="immersive-header">
      <span style="font-family:'JetBrains Mono'; color:var(--neon-cyan); font-size:0.8rem">// KERNEL RUNTIME</span>
      <div style="display:flex; gap:10px;">
          <button id="save-immersive-btn" class="fs-header-btn fs-save" data-action="save-immersive">ðŸ’¾ SALVAR COMO STACK</button>
          <button class="fs-header-btn" style="border-color:rgba(255,0,0,0.3); color:#ff5555;" data-action="close-immersive">ENCERRAR</button>
      </div>
    </div>
    <div id="immersiveContainer" style="width:100%; height:100%;"></div>
  </div>

  <div class="layout">
    
    <div>
      <div class="fusion-card" id="mainCard">
        <div class="card-header" data-action="toggle-fusion">
          <div class="avatar-ring">
            <div class="avatar-inner">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5" /></svg>
            </div>
          </div>
          <div class="header-info">
            <div class="brand">DUAL // KERNEL</div>
            <div class="status" id="statusText">SISTEMA ATIVO</div>
          </div>
          <div id="chevron" style="opacity:0.5; transition:0.3s"><i data-lucide="chevron-down"></i></div>
        </div>

        <div class="recursive-block">
          <div style="font-size:0.7rem; color:rgba(255,255,255,0.4); text-transform:uppercase;">IdentificaÃ§Ã£o</div>
          <input type="text" class="cyber-input" id="userInput" placeholder="User ID..." autocomplete="off">
        </div>

        <div class="recursive-block">
           <div class="ascii-box" id="asciiTarget" style="font-family:'JetBrains Mono'; font-size:0.6rem; color:rgba(255,255,255,0.5); white-space:pre;">
+----------------+
| SYSTEM: READY  |
+----------------+
           </div>
        </div>

        <div class="recursive-block">
          <div style="font-size:0.7rem; color:rgba(255,255,255,0.4); text-transform:uppercase;">Loader</div>
          <input type="file" id="fileInput" style="display:none" accept=".html,.txt,.js,.json">
          <div class="action-row">
            <button class="icon-btn" data-action="open-file"><i data-lucide="upload"></i></button>
            <button class="icon-btn primary" id="injectBtn" disabled data-action="execute-immersive"><i data-lucide="play"></i></button>
          </div>
          <div id="fileName" style="text-align:center; font-size:0.6rem; color:var(--neon-cyan); margin-top:5px; min-height:10px;"></div>
        </div>
      </div>
    </div>

    <div>
      
      <div class="filter-bar">
        <div class="filter-pill active" data-action="filter-vault" data-filter="ALL">ALL</div>
        <div class="filter-pill" data-action="filter-vault" data-filter="APP">APPS</div>
        <div class="filter-pill" data-action="filter-vault" data-filter="CODE">CODE</div>
        <div class="filter-pill" data-action="filter-vault" data-filter="DOCS">DOCS</div>
      </div>

      <div class="master-card" id="creatorCard">
        <div class="inner">
          <div class="vault-header">
            <div class="title-group" data-action="toggle-creator">
              <span class="card-title" style="color:var(--neon-orange)">âš¡ INFINITY INJECTOR</span>
              <span class="card-meta">VAULT v11.5 â€¢ WRITE MODE</span>
            </div>
            <div class="dock">
              <button class="ico" data-action="magic-paste" style="color:var(--neon-green)"><i data-lucide="clipboard"></i></button>
              <button class="ico" data-action="toggle-creator"><i data-lucide="chevron-down"></i></button>
            </div>
          </div>
          
          <div class="content-box">
             <textarea id="mainInput" class="code-area" rows="4" placeholder="Cole seu cÃ³digo ou texto aqui..."></textarea>
             <div style="display:flex; gap:10px; margin-top:10px;">
               <input id="mainGroup" class="cyber-input" style="border:1px solid rgba(255,255,255,0.1); border-radius:8px;" placeholder="TAG (ex: APP)">
               <button class="icon-btn primary" style="flex:1; border-radius:8px; font-weight:bold;" data-action="save-manual">SALVAR</button>
             </div>
          </div>
        </div>
      </div>

      <div id="vaultList"></div>

    </div>
  </div>

  <script>
    lucide.createIcons();

    // --- STATE ---
    let items = JSON.parse(localStorage.getItem('vault_v11') || '[]');
    let currentFilter = 'ALL';
    let editingId = null;

    // --- ACTION REGISTRY (THE KERNEL) ---
    const Actions = {
      // Fusion Controls
      'toggle-fusion': () => {
        const c = document.getElementById('mainCard');
        const blocks = document.querySelectorAll('.recursive-block');
        c.classList.toggle('open');
        const isOpen = c.classList.contains('open');
        document.getElementById('chevron').style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        
        if(isOpen) setTimeout(() => blocks.forEach(b => b.classList.add('show')), 200);
        else blocks.forEach(b => b.classList.remove('show'));
      },
      
      'open-file': () => document.getElementById('fileInput').click(),
      
      'execute-immersive': () => {
        if(!loadedContent) return;
        const container = document.getElementById('immersiveContainer');
        container.innerHTML = '';
        const iframe = document.createElement('iframe');
        iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = 'none';
        iframe.sandbox = "allow-scripts allow-forms allow-same-origin";
        iframe.srcdoc = loadedContent;
        container.appendChild(iframe);
        document.getElementById('immersiveLayer').classList.add('active');
      },

      'close-immersive': () => {
        document.getElementById('immersiveLayer').classList.remove('active');
        setTimeout(() => document.getElementById('immersiveContainer').innerHTML = '', 400);
      },

      // --- NOVA AÃ‡ÃƒO: SALVAR DO UPLOAD EXTERNO ---
      'save-immersive': () => {
        if(!loadedContent) return alert("Nenhum conteÃºdo carregado na memÃ³ria.");
        const suggested = (loadedContent.split('\n')[0] || 'Unknown').replace(/[#<]/g, '').slice(0,30).trim();
        const title = prompt("Nome do Stack:", suggested) || undefined;
        const group = (prompt("Grupo (Tag):", "IMPORT") || "IMPORT").toUpperCase();
        createCard(loadedContent, group, title);
        alert("Stack Salvo com Sucesso!");
      },

      // Vault Controls
      'toggle-creator': () => document.getElementById('creatorCard').classList.toggle('expanded'),
      
      'save-manual': () => {
        const text = document.getElementById('mainInput').value;
        const group = document.getElementById('mainGroup').value;
        if(text) { createCard(text, group); document.getElementById('mainInput').value = ''; }
      },

      'magic-paste': async () => {
        try {
          const text = await navigator.clipboard.readText();
          createCard(text, "CLIPBOARD");
        } catch(e) { alert("Clipboard block"); }
      },

      'filter-vault': (ctx) => {
        currentFilter = ctx.dataset.filter;
        document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
        ctx.el.classList.add('active');
        render();
      },

      // Item Actions
      'toggle-card': (ctx) => {
        const id = ctx.dataset.id;
        if(editingId && editingId !== Number(id)) cancelEdit();
        document.getElementById(`card-${id}`).classList.toggle('expanded');
      },

      'toggle-render': (ctx) => {
        ctx.event.stopPropagation();
        toggleRender(Number(ctx.dataset.id));
      },

      'delete-card': (ctx) => {
        ctx.event.stopPropagation();
        if(confirm("Apagar Stack?")) {
           items = items.filter(i => i.id !== Number(ctx.dataset.id));
           save();
        }
      },

      'copy-card': (ctx) => {
        ctx.event.stopPropagation();
        const item = items.find(i => i.id == ctx.dataset.id);
        navigator.clipboard.writeText(item.content);
        alert("Copiado!");
      },
      
      'edit-card': (ctx) => {
        ctx.event.stopPropagation();
        startEdit(Number(ctx.dataset.id));
      },

      'save-edit': (ctx) => {
        const id = Number(ctx.dataset.id);
        const item = items.find(i => i.id === id);
        item.title = document.getElementById(`edit-title-${id}`).value;
        item.content = document.getElementById(`edit-content-${id}`).value;
        editingId = null;
        save();
      }
    };

    // Event Delegation (O CoraÃ§Ã£o do Sistema)
    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action]');
      if(!btn) return;
      const actionName = btn.dataset.action;
      if(Actions[actionName]) {
        Actions[actionName]({ el: btn, dataset: btn.dataset, event: e });
      }
    });

    // --- LOGIC ---
    let loadedContent = null;
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(!file) return;
      document.getElementById('fileName').innerText = file.name;
      const reader = new FileReader();
      reader.onload = (ev) => {
        loadedContent = ev.target.result;
        document.getElementById('injectBtn').disabled = false;
      };
      reader.readAsText(file);
    });

    document.getElementById('userInput').addEventListener('input', (e) => {
      const val = (e.target.value || 'GHOST').toUpperCase().padEnd(8).slice(0,8);
      document.getElementById('asciiTarget').innerText = `+----------------+\n| USER: ${val} |\n| STATUS: OK     |\n+----------------+`;
    });

    function createCard(content, group = "RAW", titleOverride) {
      const lines = content.trim().split('\n');
      const title = titleOverride || lines[0].substring(0, 35).replace(/[#<]/g, '').trim() || "Untitled Stack";
      items.unshift({ id: Date.now(), title, content, group: group.toUpperCase(), date: new Date().toLocaleDateString() });
      save();
    }

    function save() {
      localStorage.setItem('vault_v11', JSON.stringify(items));
      render();
    }

    function escapeHtml(str) {
      if(!str) return '';
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function render() {
      const list = document.getElementById('vaultList');
      const filtered = currentFilter === 'ALL' ? items : items.filter(i => i.group === currentFilter);
      
      list.innerHTML = filtered.map(i => {
        if(editingId === i.id) {
           return `
           <div class="master-card expanded" id="card-${i.id}">
             <div class="inner">
               <input id="edit-title-${i.id}" class="code-area" style="height:40px; min-height:0; margin-bottom:10px;" value="${escapeHtml(i.title)}">
               <textarea id="edit-content-${i.id}" class="code-area" rows="8">${escapeHtml(i.content)}</textarea>
               <div style="text-align:right; margin-top:10px;">
                  <button class="icon-btn primary" style="display:inline-flex; width:auto; padding:0 20px;" data-action="save-edit" data-id="${i.id}">SALVAR</button>
               </div>
             </div>
           </div>`;
        }

        return `
        <div class="master-card" id="card-${i.id}">
          <div class="inner">
            <div class="vault-header">
              <div class="title-group" data-action="toggle-card" data-id="${i.id}">
                <span class="card-title">${escapeHtml(i.title)}</span>
                <div class="card-meta">
                   <span class="tag-badge">${escapeHtml(i.group)}</span>
                   <span>${i.date}</span>
                </div>
              </div>
              <div class="dock">
                <button class="ico" title="Run App" data-action="toggle-render" data-id="${i.id}" style="color:var(--neon-purple)"><i data-lucide="play" size="16"></i></button>
                <button class="ico" title="Copy" data-action="copy-card" data-id="${i.id}"><i data-lucide="copy" size="16"></i></button>
                <button class="ico" title="Edit" data-action="edit-card" data-id="${i.id}"><i data-lucide="edit-2" size="16"></i></button>
                <button class="ico" title="Delete" data-action="delete-card" data-id="${i.id}" style="color:#ff5555"><i data-lucide="trash" size="16"></i></button>
              </div>
            </div>

            <div class="content-box">
              <textarea readonly class="code-area" id="txt-${i.id}" style="border:none; padding:0; background:transparent;">${escapeHtml(i.content)}</textarea>
              <div id="frame-container-${i.id}" style="display:none;"></div>
            </div>
          </div>
        </div>`;
      }).join('');
      
      lucide.createIcons();
    }

    // --- RENDER SYSTEM (WARFRAME) ---
    function toggleRender(id) {
      const txt = document.getElementById(`txt-${id}`);
      const frameBox = document.getElementById(`frame-container-${id}`);
      const item = items.find(i => i.id === id);

      if (frameBox.style.display === 'none' || frameBox.innerHTML === '') {
        txt.style.display = 'none';
        frameBox.style.display = 'block';
        frameBox.innerHTML = ''; // Limpa memÃ³ria

        // Toolbar
        const toolbar = document.createElement('div');
        toolbar.style.cssText = "display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;";
        
        // BotÃ£o Fullscreen Seguro
        const btnExpand = document.createElement('button');
        btnExpand.innerText = 'â›¶ FULLSCREEN';
        btnExpand.className = 'tag-badge';
        btnExpand.style.cursor = 'pointer'; 
        btnExpand.onclick = (e) => {
            e.stopPropagation();
            launchFullscreenSafe(item.content);
        };
        
        // BotÃ£o Fechar
        const btnClose = document.createElement('button');
        btnClose.innerText = 'âœ– CODE VIEW';
        btnClose.className = 'tag-badge'; 
        btnClose.style.cursor = 'pointer';
        btnClose.onclick = (e) => {
            e.stopPropagation();
            txt.style.display = 'block';
            frameBox.style.display = 'none';
            frameBox.innerHTML = '';
        };

        toolbar.appendChild(btnExpand);
        toolbar.appendChild(btnClose);
        frameBox.appendChild(toolbar);

        // Preview Inline
        const iframe = document.createElement('iframe');
        iframe.className = 'warframe-view';
        iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-same-origin');
        frameBox.appendChild(iframe);
        
        const doc = iframe.contentWindow.document;
        doc.open(); doc.write(item.content); doc.close();

      } else {
        txt.style.display = 'block';
        frameBox.style.display = 'none';
        frameBox.innerHTML = '';
      }
    }

    // --- FULLSCREEN INJECTOR COM FUNÃ‡ÃƒO DE SALVAR ---
    function launchFullscreenSafe(content) {
        const fs = document.createElement('div');
        fs.style.cssText = "position:fixed; inset:0; z-index:9999; background:#000; display:flex; flex-direction:column;";
        
        const header = document.createElement('div');
        header.style.cssText = "padding:10px; background:#050505; border-bottom:1px solid #333; display:flex; justify-content:flex-end; gap:10px; align-items:center;";
        
        // BOTÃƒO DE SALVAR NO VIEWER (Como Pedido)
        const btnSave = document.createElement('button');
        btnSave.innerText = "ðŸ’¾ SALVAR COMO STACK";
        btnSave.className = "fs-header-btn fs-save";
        btnSave.onclick = () => {
             const suggested = (content.split('\n')[0] || '').replace(/[#<]/g, '').slice(0,30).trim();
             const title = prompt("TÃ­tulo para Salvar:", suggested);
             if(title) {
                const group = prompt("Grupo/Tag:", "FORK").toUpperCase();
                createCard(content, group, title);
                btnSave.innerText = "SALVO! âœ”";
                setTimeout(() => btnSave.innerText = "ðŸ’¾ SALVAR COMO STACK", 2000);
             }
        };

        const closeBtn = document.createElement('button');
        closeBtn.innerText = "ENCERRAR SESSÃƒO";
        closeBtn.className = "fs-header-btn";
        closeBtn.style.color = "#ff5555";
        closeBtn.style.borderColor = "rgba(255,0,0,0.3)";
        closeBtn.onclick = () => fs.remove();
        
        header.appendChild(btnSave);
        header.appendChild(closeBtn);
        fs.appendChild(header);

        const frame = document.createElement('iframe');
        frame.style.cssText = "flex:1; border:none; background:#fff;";
        frame.sandbox = "allow-scripts allow-forms"; 
        
        fs.appendChild(frame);
        document.body.appendChild(fs);

        // PostMessage Pattern para InjeÃ§Ã£o Segura
        frame.srcdoc = `<html><body><script>window.addEventListener('message', e => { if(e.data.type==='INIT') { document.open(); document.write(e.data.html); document.close(); } }); window.parent.postMessage({type:'READY'}, '*');<\/script></body></html>`;
        
        const listener = (e) => {
            if(e.data.type === 'READY') {
                frame.contentWindow.postMessage({type: 'INIT', html: content}, '*');
                window.removeEventListener('message', listener);
            }
        };
        window.addEventListener('message', listener);
    }

    function startEdit(id) { editingId = id; render(); }
    function cancelEdit() { editingId = null; render(); }

    // Init
    render();
    setTimeout(() => document.getElementById('mainCard').classList.add('active'), 100);

  </script>
</body>
</html>
